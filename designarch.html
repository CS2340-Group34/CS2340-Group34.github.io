<!DOCTYPE html>
<html>

<head>
    <style>
        
        div.scroll {
            margin: 4px, 4px;
            padding: 4px;
            background-color: white;
            width: 1000px;
            height: 500px;
            overflow-x: hidden;
            overflow-y: auto;
            text-align: right;
            font-family: Verdana, sans-serif;
        }

        p {
            font-family: Verdana, sans-serif;
        }

        h3 {
            font-family: Verdana, sans-serif;
        }

    </style>
</head>

<body>
<h1 style="font-family: Verdana, sans-serif;"> Design and Architecture </h1>

<h3>Design Class Diagram</h3>

<img src="dcd.png" alt="dcd">

<h3>Domain Model</h3>

<h3>Sequence Diagram</h3>

<h3>System Sequence Diagram</h3>


    <center>
        <h3>Singleton Class</h3>
        <div class="scroll"> 

package com.example.cs2340ateam34;

import android.util.Log;

import androidx.annotation.NonNull;
import androidx.appcompat.app.AppCompatActivity;

import com.google.android.gms.tasks.OnCompleteListener;
import com.google.android.gms.tasks.Task;
import com.google.firebase.database.DataSnapshot;
import com.google.firebase.database.DatabaseReference;
import com.google.firebase.database.FirebaseDatabase;

import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Date;
import java.util.Map;
import java.util.Set;

public class User {
    private static volatile User instance;

    private static DatabaseReference dbRef;

    private static String uname;

    private static ArrayList<Meal> mealList;


    private static ArrayList<Ingredient> ingredientList = new ArrayList<>();

    private static ArrayList<RecipeBuilder> recipeList = new ArrayList<>();
    private static ArrayList<Ingredient> shoppingList = new ArrayList<>();

    private static int nextIngredientIndex;

    private static int nextShoppingListIndex;

    private volatile Profile profile;

    private MainActivity activity;

    private User() {
    }

    public static User getInstance() {
        if (instance == null) {
            synchronized (User.class) {
                if (instance == null) {
                    instance = new User();
                    instance.mealList = new ArrayList<>();
                    instance.profile = new Profile(-1, -1, "Undefined");
                }
            }
        }
        return instance;
    }
    public static User getInstance(String unameParam) {

        if (instance == null) {
            synchronized (User.class) {
                if (instance == null) {
                    //add code to fetch meal list and profile from relevant user account in database
                    dbRef = FirebaseDatabase.getInstance().getReference();
                    uname = unameParam;

                    initProfile(uname);
                    initMeals(unameParam);
                    initIngredients(unameParam);
                    initRecipes(unameParam);
                    initShoppingList(unameParam);
                    instance = new User();
                    instance.mealList = new ArrayList<>();
                    instance.profile = new Profile(-1, -1, "Undefined");
                }
            }
        }
        return instance;
    }


    private static void initProfile(String uname) {
        Log.d("INITING", "initing");
        dbRef.child("profile").child(uname).child("gender").get().addOnCompleteListener(
                new OnCompleteListener<DataSnapshot>() {
                    @Override
                    public void onComplete(@NonNull Task<DataSnapshot> task) {
                        String x = String.valueOf(task.getResult().getValue());
                        Log.d("GENDER", x);
                        instance.profile.setGender(x);
                    }
                });
        dbRef.child("profile").child(uname).child("height").get().addOnCompleteListener(
                new OnCompleteListener<DataSnapshot>() {
                    @Override
                    public void onComplete(@NonNull Task<DataSnapshot> task) {
                        String x = String.valueOf(task.getResult().getValue());
                        Log.d("Height", x);
                        instance.profile.setHeight(Integer.parseInt(x));
                    }
                });
        dbRef.child("profile").child(uname).child("weight").get().addOnCompleteListener(
                new OnCompleteListener<DataSnapshot>() {
                    @Override
                    public void onComplete(@NonNull Task<DataSnapshot> task) {
                        String x = String.valueOf(task.getResult().getValue());
                        Log.d("Weight", x);
                        instance.profile.setWeight(Integer.parseInt(x));
                    }
                });

    }
    private static void initMeals(String uname) {

        Log.d("meals", "meals");
        dbRef.child("meals").child(uname).get().addOnCompleteListener(
                new OnCompleteListener<DataSnapshot>() {
                    @Override
                    public void onComplete(@NonNull Task<DataSnapshot> task) {
                        Log.d("meals", "meals");
                        Map data = (Map) (task.getResult().getValue());
                        Log.d("meals", "mealsadfa");
                        Set<String> keyset = data.keySet();
                        Meal[] tempmeallist = new Meal[keyset.size() - 1];
                        for (String key : keyset) {
                            if (key.equals("initmeal")) {
                                continue;
                            }
                            Log.d("madsf", key);
                            Map mealMap = (Map) (data.get(key));
                            String name = mealMap.get("name").toString();
                            int calories = Integer.parseInt(mealMap.get("calories").toString());
                            int price = Integer.parseInt(mealMap.get("price").toString());
                            String date = mealMap.get("date").toString();
                            Meal meal = new Meal(name, calories, price, date);
                            tempmeallist[Integer.parseInt(key)] = meal;
                            Log.d("madsfnamename", name);
                            Log.d("madsfnamecalories", "" + calories);
                            Log.d("madsfnameprice", "" + price);
                            Log.d("madsfnamedate",  date);
                        }
                        for (Meal meal : tempmeallist) {
                            mealList.add(meal);
                        }
                    }
                });
    }
    private static void initIngredients(String uname) {

        dbRef.child("pantry").child(uname).get().addOnCompleteListener(
                new OnCompleteListener<DataSnapshot>() {
                    @Override
                    public void onComplete(@NonNull Task<DataSnapshot> task) {
                        Map data = (Map) (task.getResult().getValue());
                        Set<String> keyset = data.keySet();
                        for (String key : keyset) {
                            if (key.equals("metadata")) {
                                Map metaMap = (Map) (data.get(key));
                                nextIngredientIndex = Integer.
                                        parseInt(metaMap.get("nextindex").toString());
                                continue;
                            }
                            Log.d("madsf", key);
                            Map ingredientMap = (Map) (data.get(key));
                            String name = ingredientMap.get("name").toString();
                            int calories = Integer.parseInt(
                                    ingredientMap.get("calories").toString());
                            int quantity = Integer.parseInt(
                                    ingredientMap.get("quantity").toString());
                            String expiry = ingredientMap.get("expiry").toString();
                            int index = Integer.parseInt(key.toString());
                            Ingredient ingredient = new Ingredient(
                                    name, quantity, calories, expiry, index);
                            ingredientList.add(ingredient);
                        }
                    }
                });
    }
    private static void initShoppingList(String uname) {

        dbRef.child("shoppinglist").child(uname).get().addOnCompleteListener(
                new OnCompleteListener<DataSnapshot>() {
                    @Override
                    public void onComplete(@NonNull Task<DataSnapshot> task) {
                        Map data = (Map) (task.getResult().getValue());
                        Set<String> keyset = data.keySet();
                        //Ingredient[] tempingredientlist = new Ingredient[keyset.size() - 1];
                        for (String key : keyset) {
                            if (key.equals("metadata")) {
                                Map metaMap = (Map) (data.get(key));
                                nextShoppingListIndex = Integer.
                                        parseInt(metaMap.get("nextindex").toString());
                                continue;
                            }
                            Log.d("madsf", key);
                            Map ingredientMap = (Map) (data.get(key));
                            String name = ingredientMap.get("name").toString();
                            int calories = Integer.parseInt(
                                    ingredientMap.get("calories").toString());
                            int quantity = Integer.parseInt(
                                    ingredientMap.get("quantity").toString());
                            String expiry = ingredientMap.get("expiry").toString();
                            int index = Integer.parseInt(key.toString());
                            Ingredient ingredient = new Ingredient(
                                    name, quantity, calories, expiry, index);
                            shoppingList.add(ingredient);
                        }
                    }
                });
    }
    private static void initRecipes(String uname) {

        dbRef.child("recipes").get().addOnCompleteListener(
                new OnCompleteListener<DataSnapshot>() {
                    @Override
                    public void onComplete(@NonNull Task<DataSnapshot> task) {
                        Map data = (Map) (task.getResult().getValue());
                        Set<String> keyset = data.keySet();
                        for (String key : keyset) {
                            if (key.equals("metadata")) {
                                continue;
                            }
                            Log.d("madsf", key);
                            String name = key.toString();
                            Map recipeMap = (Map) (data.get(key));
                            RecipeBuilder recipe = new RecipeBuilder(name);
                            Set<String> innerKeySet = recipeMap.keySet();
                            for (String itemName : innerKeySet) {
                                int quantity = Integer.parseInt(recipeMap.get(itemName).toString());
                                recipe.addComponent(itemName, quantity);
                            }
                            recipeList.add(recipe);
                        }
                        /*for (Ingredient ingredient : tempingredientlist) {
                            ingredientList.add(ingredient);
                        }*/
                    }
                });
    }
    public void addMeal(Meal meal) {
        // Get current date
        Date currentDate = new Date();

        // Define the date format
        SimpleDateFormat dateFormat = new SimpleDateFormat("MM-dd-yyyy");

        // Format the current date
        String formattedDate = dateFormat.format(currentDate);

        dbRef.child("meals").child(uname).child(""
                + mealList.size()).child("name").setValue(meal.getMealName());
        dbRef.child("meals").child(uname).child(""
                + mealList.size()).child("calories").setValue(meal.getCalories());
        dbRef.child("meals").child(uname).child(""
                + mealList.size()).child("price").setValue(meal.getPrice());
        dbRef.child("meals").child(uname).child(""
                + mealList.size()).child("date").setValue(formattedDate);
        mealList.add(meal);

    }

    public void addIngredientShoppingList(Ingredient ingredient) {
        ingredient.setIndex(nextShoppingListIndex);
        dbRef.child("shoppinglist").child(uname).child("" + nextShoppingListIndex).child(
                "name").setValue(ingredient.getIngredientName());
        dbRef.child("shoppinglist").child(uname).child("" + nextShoppingListIndex).child(
                "calories").setValue(ingredient.getCalories());
        dbRef.child("shoppinglist").child(uname).child("" + nextShoppingListIndex).child(
                "quantity").setValue(ingredient.getQuantity());
        dbRef.child("shoppinglist").child(uname).child("" + nextShoppingListIndex).child(
                "expiry").setValue(ingredient.getExpiry());
        shoppingList.add(ingredient);
        Log.d("" + shoppingList.size(), "asef");
        nextShoppingListIndex++;
        dbRef.child("shoppinglist").child(uname).child("metadata").child(
                "nextindex").setValue(nextShoppingListIndex);
    }
    public void addIngredient(Ingredient ingredient) {
        ingredient.setIndex(nextIngredientIndex);
        Log.d("ingredientcration", "" + ingredient.getIndex() + ingredient.getIngredientName());
        dbRef.child("pantry").child(uname).child("" + nextIngredientIndex).child(
                "name").setValue(ingredient.getIngredientName());
        dbRef.child("pantry").child(uname).child("" + nextIngredientIndex).child(
                "calories").setValue(ingredient.getCalories());
        dbRef.child("pantry").child(uname).child("" + nextIngredientIndex).child(
                "quantity").setValue(ingredient.getQuantity());
        dbRef.child("pantry").child(uname).child("" + nextIngredientIndex).child(
                "expiry").setValue(ingredient.getExpiry());
        ingredientList.add(ingredient);

        nextIngredientIndex++;
        dbRef.child("pantry").child(uname).child("metadata").child(
                "nextindex").setValue(nextIngredientIndex);
    }

    public void updateIngredient(Ingredient ingredient, int value) {
        Log.d("BRUHHUUHUHUHUH", "" + ingredient.getIndex() + ingredient.getIngredientName());
        int index = ingredient.getIndex();
        if (ingredient.getQuantity() + value <= 0) {
            dbRef.child("pantry").child(uname).child("" + index).removeValue();
            Log.d("a", "" + ingredientList.size());
            ingredientList.remove(ingredient);
            Log.d("b", "" + ingredientList.size());
        } else {
            dbRef.child("pantry").child(uname).child("" + index).child(
                    "quantity").setValue(ingredient.getQuantity() + value);
            ingredient.setQuantity(ingredient.getQuantity() + value);
        }
    }


    public void addRecipe(RecipeBuilder recipe) {
        ArrayList<RecipeComponent> recipeItems = recipe.recipeToArray();
        for (RecipeComponent item: recipeItems) {
            dbRef.child("recipes").child(recipe.getName()).child(item.getName()).setValue(
                    item.getQuantity());
        }
        recipeList.add(recipe);
    }
    public void updateIngredientShoppingList(Ingredient ingredient, int value) {
        int index = ingredient.getIndex();
        if (ingredient.getQuantity() + value <= 0 || value == 0) {
            dbRef.child("shoppinglist").child(uname).child("" + index).removeValue();
            Log.d("a", "" + ingredientList.size());
            shoppingList.remove(ingredient);
            Log.d("b", "" + ingredientList.size());
        } else {
            dbRef.child("shoppinglist").child(uname).child("" + index).child(
                    "quantity").setValue(ingredient.getQuantity() + value);
            ingredient.setQuantity(ingredient.getQuantity() + value);
        }
    }

    public void buyIngredient(Ingredient ingredient) {
        updateIngredientShoppingList(ingredient, 0);
        for (Ingredient pantryIngredient : ingredientList) {
            if (pantryIngredient.getIngredientName().equals(ingredient.getIngredientName())) {
                updateIngredient(pantryIngredient, ingredient.getQuantity());
                return;
            }
        }
        ingredient.setBuying(false);
        addIngredient(ingredient);

    }            

    public boolean checkRecipe(RecipeBuilder recipe) {
        for (RecipeComponent recipeItem : recipe.recipeToArray()) {
            boolean itemValid = false;
            for (Ingredient  ingredient : ingredientList) {
                if (ingredient.getIngredientName().equals(recipeItem.getName())) {
                    if (ingredient.getQuantity() >= recipeItem.getQuantity()) {
                        itemValid = true;
                        break;
                    }
                }
            }
            if (!itemValid) {
                return false;
            }
        }
        return true;
    }
    public String getUname() {
        return uname;
    }
    public String getProfGender() {
        Log.d("h", "h");
        return profile.getGender();
    }
    public void setProfGender(String inputGender) {
        profile.setGender(inputGender);
        dbRef.child("profile").child(uname).child("gender").setValue(
                inputGender);
    }
    public int getProfHeight() {
        return profile.getHeight();
    }
    public void setProfHeight(int inputHeight) {
        profile.setHeight(inputHeight);
        dbRef.child("profile").child(uname).child("height").setValue(
                inputHeight);
    }
    public int getProfWeight() {
        return profile.getWeight();
    }
    public void setProfWeight(int inputWeight) {
        profile.setWeight(inputWeight);
        dbRef.child("profile").child(uname).child("weight").setValue(
                inputWeight);
    }

    public double getCurrDayCalorieIntake() {
        // Get current date
        Date currentDate = new Date();

        // Define the date format
        SimpleDateFormat dateFormat = new SimpleDateFormat("MM-dd-yyyy");

        // Format the current date
        String formattedDate = dateFormat.format(currentDate);

        double out = 0;
        for (Meal meal : mealList) {
            if (meal.getDate().equals(formattedDate)) {
                out += meal.getCalories();
            }
        }
        return out;
    }

    public ArrayList<Meal> getMealList() {
        return mealList;
    }
    public ArrayList<Ingredient> getIngredientList() {
        return ingredientList;
    }
    public int getNextIngredientIndex() {
        return nextIngredientIndex;
    }

    public ArrayList<RecipeBuilder> getRecipeList() {
        return recipeList;
    }
    public MainActivity getActivity() {
        return activity;
    }
    public void setActivity(AppCompatActivity activity) {
        this.activity = (MainActivity) activity;
    }
    public ArrayList<Ingredient> getShoppingList() {
        return shoppingList;
    }

}       </div>
    </center>

<p> In this prokect we implemented the Singleton design pattern for the User class. The user class is the representation of a single user, and stores the name, height, gender and weight of this user, that can be accessible any time. It has two get-instance methods, one with a parameter and one without, and the user is initialized within these methods. The class includes a few methods that initalizes the profile, meals, recipes, the shopping list, and it has add/update meals, recipes and ingredients methods and getters and setters. Whenever a User is initialized another user cannot be initialized, and will contain the exact same values as the initial one if it is created. The singleton class represents the user using the app on their phone, and since itâ€™s only one person, and one account the User class will always be a single instance. We used the Firebase database to store this user's information from their activity on the application. </p>

</body>

</html>